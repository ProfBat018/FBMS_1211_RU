# Тема урока. 
* Multistage build
* Docker vnetwork
* Docker compose


# Multistage build

## Что такое Multistage build ?
Multistage build - это возможность создавать образы, которые состоят из нескольких этапов. Предположим, что нам надо собрать два проекта на .NET Core, один из которых является веб-приложением, а второй консольным приложением. Для этого нам надо создать два образа, которые будут содержать в себе все необходимые зависимости для сборки проектов. Но, если мы будем использовать обычный докерфайл, то мы получим два образа, которые будут содержать в себе все зависимости, которые нам необходимы для сборки проектов. Но, если мы будем использовать Multistage build, то мы получим два образа, которые будут содержать в себе только те зависимости, которые нам необходимы для запуска приложений.

Например .NET проект находится по пути /work/app, а веб-приложение по пути /work/webapp. Тогда докерфайл будет выглядеть следующим образом:

```dockerfile

# Сборка проекта
FROM mcr.microsoft.com/dotnet/core/sdk:7.0 
COPY . /work/app as build-env
WORKDIR /work/app
RUN dotnet publish -c Release -o out

# Запуск приложения
FROM mcr.microsoft.com/dotnet/core/aspnet:7.0  
COPY --from=build-env /work/app/out /work/webapp
WORKDIR /work/webapp
ENTRYPOINT ["dotnet", "webapp.dll"]

```

## Как это работает ?

Когда мы запускаем команду docker build, то Docker собирает все слои, которые находятся в докерфайле. Но, если в докерфайле есть несколько FROM, то Docker собирает только те слои, которые находятся после последней команды FROM. То есть, в нашем случае Docker соберет только те слои, которые находятся после команды FROM mcr.microsoft.com/dotnet/core/aspnet:7.0. Таким образом, мы получим два образа, которые будут содержать в себе только те зависимости, которые нам необходимы для запуска приложений.


## Docker Compose 

Compose - он исходит из слова composition, что в переводе означает композиция.

Docker Compose - это очень удобный инструмент, который позволяет запускать несколько контейнеров одновременно. Например, если мы хотим запустить приложение на .NET Core, то нам надо сначала запустить контейнер с базой данных, а затем запустить контейнер с приложением. Но, если мы будем использовать Docker Compose, то мы сможем запустить оба контейнера одной командой.



## Что такое Compose и  какова его роль в разработке приложений ?

Начнем с того, что docker compose нужен если вы работаете сразу с несколькими контейнерами. 
К примеру, у нас есть абсолютно три разных приложения которые должны взаимодействовать друг с другом. Это конечно же можно сделать без docker compose, но это будет не так удобно и не так просто как с docker compose.

### Как это сделать без Docker Compose ?
* Создать каждое приложение отдельно в своем контейнере
* Создать сеть для взаимодействия между контейнерами
* Запустить каждый контейнер в этой сети

#### Как создать свою сеть ?
```bash
docker network create my-network
```

#### Как запустить контейнер в этой сети ?
```bash
docker run -d --name my-appContainer --network my-network my-appImage

-d - background mode
--name - name of container
--network - network name
my-app - image name
```

Просто если мы хотим запустить несколько контейнеров, то нам надо будет запускать каждый контейнер отдельно и каждый раз указывать имя сети. Но, если мы будем использовать Docker Compose, то мы сможем запустить все контейнеры одной командой. 


### Как это сделать с Docker Compose ?

* Создать файл docker-compose.yml
* Описать в нем все контейнеры, которые нам необходимы
* Запустить все контейнеры одной командой

#### Как создать файл docker-compose.yml ?
```bash
version: '3.7'
services:
  my-app:
    image: my-app
    container_name: my-appContainer
    networks:
      - my-network
  my-db:
    image: my-db
    container_name: my-dbContainer
    networks:
      - my-network
```





