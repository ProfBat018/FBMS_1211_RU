# –¢–µ–º–∞ —É—Ä–æ–∫–∞. –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è 

## –ß—Ç–æ —Ç–∞–∫–æ–µ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è ? –ó–∞—á–µ–º –Ω–∞–º –µ–≥–æ –Ω–∞–¥–æ –∑–Ω–∞—Ç—å ? 

1. –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è - —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —É –Ω–∞—Å –µ—Å—Ç—å –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.

–ù–æ —á—Ç–æ —Ç–∞–∫–æ–µ –∫–ª–∞—Å—Ç–µ—Ä ? 
–ö–ª–∞—Å—Ç–µ—Ä - —ç—Ç–æ –Ω–∞–±–æ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É –Ω–∞—Å –µ—Å—Ç—å.

## –û–¥–∏–Ω –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ - —ç—Ç–æ `Kubernetes` –∏ `Docker Swarm`

–ï—Å–ª–∏ –∏—Ö —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º, —Ç–æ —è –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å –∏–∑ –ª–∏—á–Ω–æ–≥–æ –æ–ø—ã—Ç–∞ swarm —É–∂–µ –æ—Å–æ–±–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –æ–Ω –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏, —á–µ–º kubernetes –∏ –Ω–∞–º –µ–≥–æ –Ω–∞–¥–æ –∑–Ω–∞—Ç—å –≤ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ª—è—Ö, —Ç–∞–∫ –∂–µ –∫–∞–∫ –∏ –º—ã –≤—ã—É—á–∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–∏—Ö –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π, —Ö–æ—Ç—å —ç—Ç–æ –∏ –¥–µ–ª–∞–µ—Ç Docker Compose. 

## –î–∞–≤–∞–π—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–≥–æ–≤–æ—Ä–∏–º –ø—Ä–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —É—Ç–∏–ª–∏—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –µ—Å—Ç—å –≤ Docker. –ù–∞–∑—ã–≤–∞–µ—Å—Ç—Å—è –æ–Ω Docker Swarm.

### Docker Swarm - —ç—Ç–æ —É—Ç–∏–ª–∏—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–æ–º –∏–∑ Docker-—Ö–æ—Å—Ç–æ–≤. –û–Ω –¥–µ–ª–∏—Ç—Å—è –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏ 
- –º–µ–Ω–µ–¥–∂–µ—Ä—ã (manager)
- —Ä–∞–±–æ—á–∏–µ (worker)

![swarm.png](swarm.png)


### –ú–µ–Ω–µ–¥–∂–µ—Ä—ã - —ç—Ç–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —É–ø—Ä–∞–≤–ª—è—é—Ç –∫–ª–∞—Å—Ç–µ—Ä–æ–º. –û–Ω–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –∫–æ–º–∞–Ω–¥—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç –∏—Ö –ø–æ —Ä–∞–±–æ—á–∏–º.

### –†–∞–±–æ—á–∏–µ - —ç—Ç–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—à–ª–∏ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.

## –¢–µ—Ä–º–∏–Ω—ã
–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è swarm –Ω–∞–¥–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π:

`Node` - —ç—Ç–æ –Ω–∞—à–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω docker. –ï—Å—Ç—å manager –∏ workers –Ω–æ–¥—ã. Manager –Ω–æ–¥–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç workers –Ω–æ–¥–∞–º–∏. –û–Ω–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ workers, –∞ —Ç–∞–∫–∂–µ –∑–∞ –∏—Ö –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ —Ç—Ä–µ–±—É–µ–º–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏. Workers –Ω–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∏ –Ω–µ –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–æ–º.

`Stack` - —ç—Ç–æ –Ω–∞–±–æ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π. –ü–æ —Å—É—Ç–∏ —ç—Ç–æ –Ω–∞–±–æ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –æ–ø–∏—Å—ã–≤–∞–µ–º –≤ –æ–±—ã—á–Ω–æ–º compose —Ñ–∞–π–ª–µ. –ß–∞—Å—Ç–∏ stack (services) –º–æ–≥—É—Ç —Ä–∞—Å–ø–æ–ª–∞–≥–∞—Ç—å—Å—è –∫–∞–∫ –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–¥–µ, —Ç–∞–∫ –∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö.

`Service` - —ç—Ç–æ –∫–∞–∫ —Ä–∞–∑ —Ç–æ, –∏–∑ —á–µ–≥–æ —Å–æ—Å—Ç–æ–∏—Ç stack. Service —è–≤–ª—è–µ—Ç—Å—è –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ç–æ–≥–æ, –∫–∞–∫–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è. –ï—Å–ª–∏ –≤—ã –ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å docker-compose.yaml, —Ç–æ —É–∂–µ –∑–Ω–∞–∫–æ–º—ã —Å —ç—Ç–æ–π —Å—É—â–Ω–æ—Å—Ç—å—é. –ö—Ä–æ–º–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–æ–ª–µ–π docker –≤ —Ä–µ–∂–∏–º–µ swarm –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—è–¥ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏ deploy.

`Task` - —ç—Ç–æ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π docker —Å–æ–∑–¥–∞–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –º—ã —É–∫–∞–∑–∞–ª–∏ –ø—Ä–∏ –æ–ø–∏—Å–∞–Ω–∏–∏ service. Swarm –±—É–¥–µ—Ç —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –µ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é –Ω–æ–¥—É.


### –î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞
–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –∫–ª–∞—Å—Ç–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–ª, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–∫—Ä—ã—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ—Ä—Ç—ã –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö. 
–î–ª—è manager node:
- TCP port 2377 for cluster management communications
- TCP and UDP port 7946 for communication among nodes
- UDP port 4789 for overlay network traffic

```
firewall-cmd --add-port=2376/tcp --permanent;
firewall-cmd --add-port=2377/tcp --permanent;
firewall-cmd --add-port=7946/tcp --permanent;
firewall-cmd --add-port=7946/udp --permanent;
firewall-cmd --add-port=4789/udp --permanent;
firewall-cmd --reload;

systemctl restart docker;
```

–î–ª—è worker node:
- TCP and UDP port 7946 for communication among nodes
- UDP port 4789 for overlay network traffic

```
firewall-cmd --add-port=2376/tcp --permanent;
firewall-cmd --add-port=7946/tcp --permanent;
firewall-cmd --add-port=7946/udp --permanent;
firewall-cmd --add-port=4789/udp --permanent;
firewall-cmd --reload;

systemctl restart docker;
```

–ó–∞—Ç–µ–º –∑–∞—Ö–æ–¥–∏–º –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —É –Ω–∞—Å manager node. –ò –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É:


```
docker swarm init 
```

–ï—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ, —Ç–æ –≤ –æ—Ç–≤–µ—Ç –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É:

```
docker swarm join --token SWMTKN- ...
```


–ï–µ –±—É–¥–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –≤—Å–µ—Ö worker node, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å –∏—Ö –≤ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä.

–ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ, –≤—ã–ø–æ–ª–Ω–∏–≤ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É –Ω–∞ manager –Ω–æ–¥–µ –≤ –∫–æ–Ω—Å–æ–ª–∏, –≤—ã —É–≤–∏–¥–∏—Ç–µ —á—Ç–æ-—Ç–æ –ø–æ–¥–æ–±–Ω–æ–µ:


```
docker node ls
ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
vj7kp5847rh5mbbqn97ghyb72 *   dev-2      Ready     Active         Leader           20.10.14
zxo15m9wqdjd9f8pvg4gg6gwi     stage      Ready     Active                    
```

–í –ø—Ä–∏–Ω—Ü–∏–ø–µ –º—ã –≥–æ—Ç–æ–≤—ã –∫ —Ç–æ–º—É, —á—Ç–æ–±—ã –∑–∞–ø—É—Å–∫–∞—Ç—å services –∏ stacks –Ω–∞ –Ω–∞—à–µ–π worker node.

–ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º —É–±—Ä–∞—Ç—å –Ω–æ–¥—É –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–π—Ç–∏ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª–∫—É, –∫–æ—Ç–æ—Ä–∞—è —è–≤–ª—è–µ—Ç—Å—è –µ—é, –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:

```
docker swarm leave
```

–ï—Å–ª–∏ –∑–∞—Ç–µ–º –∑–∞–π—Ç–∏ –Ω–∞ manager –Ω–æ–¥—É –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å docker node ls, –≤—ã –∑–∞–º–µ—Ç–∏—Ç–µ, —á—Ç–æ —Å—Ç–∞—Ç—É—Å —É –Ω–µ–µ –ø–æ–º–µ–Ω—è–ª—Å—è c Ready –Ω–∞ Down (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è). Swarm –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—É—é –Ω–æ–¥—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –∏ –≤—ã –º–æ–∂–µ—Ç–µ —Å–ø–æ–∫–æ–π–Ω–æ –∑–∞–Ω—è—Ç—å—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ä–∞–±–æ—Ç–∞–º–∏, –Ω–µ –±–æ—è—Å—å –Ω–∞–Ω–µ—Å—Ç–∏ –≤—Ä–µ–¥ —Ä–∞–±–æ—Ç–∞—é—â–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º. –î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å –Ω–æ–¥—É, –Ω–∞–¥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å (–Ω–∞ manager node):

```
docker node rm stage
```

–°—Ç—ç–∫ –∏ –°–µ—Ä–≤–∏—Å
–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—à–µ–≥–æ —Å—Ç—ç–∫–∞ —è –≤–æ–∑—å–º—É –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞ compose —Ñ–∞–π–ª –¥–ª—è node js web server, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç –ø–æ—Ä—Ç 4003:

```yaml
services:
  back:
    image: docker-registry.ru:5000/ptm:stage
    ports:
      - "4003:4003"
    environment:
      TZ: "Europe/Moscow"
    extra_hosts:
      - host.docker.internal:host-gateway
    command: make server_start
    volumes:
      - /p/ptm/config/config.yaml:/p/ptm/config/config.yaml
      - /p/ptm/stat/web:/p/ptm/stat/web
```

–í –Ω–∞—á–∞–ª–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ—Å—Ç–∞—Ç—å image –∏–∑ registry –∏ —Ç–æ–ª—å–∫–æ –∑–∞—Ç–µ–º –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –≤ –Ω–∞—à –∫–ª–∞—Å—Ç–µ—Ä:
```
docker pull docker-registry.ru:5000/ptm:stage;
docker stack deploy --with-registry-auth -c ./docker-compose.stage.yaml stage;
```

–î–ª—è docker-compose.prod.yaml –±—É–¥–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ —Å —Ç—ç–≥–æ–º prod (–æ–¥–Ω–∞–∫–æ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –º–∏—Ä–∞ –Ω–∞–¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä 4004). –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –¥–∞–Ω–Ω—ã—Ö stacks –≤—ã —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –Ω–æ–¥–∞—Ö —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —Ç—ç–≥–æ–º.


# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è 
–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —É –Ω–∞—Å 3 –Ω–æ–¥—ã: manager –Ω–æ–¥–∞, –Ω–æ–¥–∞ –¥–ª—è stage –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –µ—â–µ –æ–¥–Ω–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.

```
docker node ls
ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
vj7kp5847rh5mbbqn97ghyb72 *   dev-2      Ready     Active         Leader           20.10.14
k3wjrl2o827in7k55wqfjfyxs     prod-1     Ready     Active                          20.10.14
zxo15m9wqdjd9f8pvg4gg6gwi     stage      Ready     Active  
```

–ò –µ—Å–ª–∏ –º—ã –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞—à —Å—Ç—ç–∫ –¥–ª—è docker-compose.prod.yaml –Ω–∞ —Ç–æ–º –∂–µ 4003 –ø–æ—Ä—Ç—É, —á—Ç–æ –∏ –¥–ª—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —Å—Ç—ç–∫–∞ docker-compose.stage.yaml, –º—ã –ø–æ–ª—É—á–∏–º –æ—à–∏–±–∫—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å —Ç–µ–º, —á—Ç–æ –ø–æ—Ä—Ç —É–∂–µ –∑–∞–Ω—è—Ç.

–•–º–º–º... –ø–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?ü§î –ò –±–æ–ª–µ–µ —Ç–æ–≥–æ, –µ—Å–ª–∏ –º—ã –∑–∞–π–¥–µ–º –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É prod-1 –∏ —Å–¥–µ–ª–∞–µ–º curl 127.0.0.1:4003, —Ç–æ —É–≤–∏–¥–∏–º, —á—Ç–æ –Ω–∞—à —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω, —Ö–æ—Ç—è –Ω–∞ —ç—Ç–æ–π –Ω–æ–¥–µ –º—ã –µ—â–µ –Ω–µ —É—Å–ø–µ–ª–∏ –Ω–∏—á–µ–≥–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å ?


–°–≤—è–∑–∞–Ω–æ —ç—Ç–æ —Å —Ç–µ–º, —á—Ç–æ —É swarm –∏–º–µ–µ—Ç—Å—è ingress —Å–µ—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞—Ñ—Ñ–∏–∫–∞ –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏. –ï—Å–ª–∏ —É —Å–µ—Ä–≤–∏—Å–∞ –µ—Å—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ—Ä—Ç, —Ç–æ swarm —Å–ª—É—à–∞–µ—Ç –µ–≥–æ –∏ –≤ —Å–ª—É—á–∞–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –Ω–µ–≥–æ –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ —ç—Ç–æ–π —Ö–æ—Å—Ç –º–∞—à–∏–Ω–µ –∏ –µ—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç –Ω–æ–¥—É, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –∑–∞–ø—É—â–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞, –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Ç—É–¥–∞.

![ingress.png](ingress.png)




–í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω–∏–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ HAProxy, –∫–æ—Ç–æ—Ä—ã–π –±–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –º–µ–∂–¥—É —Ç—Ä–µ–º—è –≤–∏—Ä—Ç—É–∞–ª–∫–∞–º–∏, –∞ –¥–∞–ª—å—à–µ swarm –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã.

–í–æ—Ç –ø–æ—á–µ–º—É –ø—Ä–∏–¥–µ—Ç—Å—è –¥–ª—è docker-compose.prod.yaml –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ—Ä—Ç, –æ—Ç–ª–∏—á–Ω—ã–π –æ—Ç —Ç–æ–≥–æ, –∫–æ—Ç–æ—Ä—ã–π –º—ã —É–∫–∞–∑–∞–ª–∏ –≤ docker-compose.stage.yaml.

–û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é —Ç—Ä–∞—Ñ–∏–∫–∞ –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é mode: host –ø—Ä–∏ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏ ports:
```

# docker-compose.prod.yaml
version: "3.9"

services:
  back:
    image: docker-registry.ru:5000/ptm:stage
    ports:
		  - target: 4003
    		published: 4004
		    protocol: tcp
    		mode: host
    environment:
      TZ: "Europe/Moscow"
    extra_hosts:
      - host.docker.internal:host-gateway
    command: make server_start
    volumes:
      - /p/ptm/config/config.yaml:/p/ptm/config/config.yaml
      - /p/ptm/stat/web:/p/ptm/stat/web
    # swarm
    deploy:
      placement:
        constraints:
          - "node.labels.TAG==prod"

```

–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–¥–µ—Ç –Ω–∞ –ø–æ—Ä—Ç 4004, swarm –±—É–¥–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–µ–∫—É—â–µ–π –Ω–æ–¥–µ –∏ –Ω–∏–∫—É–¥–∞ –±–æ–ª—å—à–µ.

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –Ω–∞–¥–æ —É–ø–æ–º—è–Ω—É—Ç—å –ø—Ä–æ —Ç–∞–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∫–∞–∫ mode, —Ö–æ—Ç—è –Ω–∞–ø—Ä—è–º—É—é —ç—Ç–æ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏. –û–Ω–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è: global –∏–ª–∏ replicated (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):

```
deploy:
	mode: global

deploy:
	mode: replicated
  replicas: 4
```